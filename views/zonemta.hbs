<div class="my-4">
    <h1 class="mb-4">ZoneMTA Config Editor</h1>

    <!-- Section Buttons -->
    <div class="mb-4 d-flex align-items-center gap-2">
        <button class="btn btn-secondary" id="btnZones">Zones</button>
        <button class="btn btn-secondary" id="btnPools">Pools</button>
        <button class="btn btn-secondary" id="btnInterfaces">SMTP Feeder</button>
    </div>

    <!-- File Controls -->
    <div class="mb-4 d-flex align-items-center gap-2">
        <input type="text" id="fileName" class="form-control mb-4" placeholder="Enter filename"
            style="max-width: 300px;" />
        <button class="btn btn-secondary" id="loadFileBtn">Load</button>
        <button class="btn btn-primary" id="createFileBtn">Create</button>
        <button class="btn btn-danger" id="deleteFileBtn">Delete</button>
    </div>

    <form id="configForm">
        <!-- Zones Section -->
        <div class="col-md-12 mb-4 config-section" id="zones">
            <h3>Zones</h3>
            <div class="mb-3 col-md-2">
                <label class="form-label">Zone Name</label>
                <input class="form-control" type="text" id="zone_name" placeholder="Enter Zone Name">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Prefer IPv6</label>
                <select class="form-control" id="zone_preferIPv6">
                    <option value="false" selected>No</option>
                    <option value="true">Yes</option>
                </select>
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Ignore IPv6</label>
                <select class="form-control" id="zone_ignoreIPv6">
                    <option value="true" selected>Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Processes</label>
                <input class="form-control" type="number" id="zone_processes" placeholder="Enter Processes">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Connections</label>
                <input class="form-control" type="number" id="zone_connections" placeholder="Enter Connections">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Pool</label>
                <input class="form-control" type="text" id="zone_pool" placeholder="Enter Pool Name">
            </div>
            <div class="mb-3 col-md-4">
                <label class="form-label">Sender Domains (comma separated)</label>
                <input class="form-control" type="text" id="zone_senderDomains" placeholder="Enter Sender Domains">
            </div>
            <div class="mb-3 col-md-4">
                <label class="form-label">Recipient Domains (comma separated)</label>
                <input class="form-control" type="text" id="zone_recipientDomains"
                    placeholder="Enter Recipient Domains">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Throttling</label>
                <input class="form-control" type="text" id="zone_throttling" placeholder="Enter Throttling">
            </div>
        </div>

        <!-- Pools Section (UPDATED) -->
        <div class="col-md-12 mb-4 config-section" id="pools" style="display:none;">
            <h3>Pools</h3>
            <div class="mb-3 col-md-2">
                <label class="form-label">Pool Name</label>
                <input class="form-control" type="text" id="pool_name" placeholder="Enter Pool Name">
            </div>

            <div id="nodesContainer" class="mb-3">
                <!-- Node rows will be added dynamically -->
            </div>

            <button type="button" class="btn btn-secondary mb-3" id="addNodeBtn">Add Node</button>
        </div>

        <!-- SMTP Feeder Section -->
        <div class="col-md-12 mb-4 config-section" id="interfaces" style="display:none;">
            <h3>SMTP Feeder</h3>
            <div class="mb-3 col-md-2">
                <label class="form-label">Enabled</label>
                <select class="form-control" id="interfaces_enabled">
                    <option value="true" selected>Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Processes</label>
                <input class="form-control" type="number" id="interfaces_processes" placeholder="Enter Processes">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Max Size (bytes)</label>
                <input class="form-control" type="number" id="interfaces_maxSize" placeholder="Enter Max Size">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Host</label>
                <input class="form-control" type="text" id="interfaces_host" placeholder="Enter Host">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Port</label>
                <input class="form-control" type="number" id="interfaces_port" placeholder="Enter Port">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Authentication</label>
                <select class="form-control" id="interfaces_authentication">
                    <option value="false" selected>No</option>
                    <option value="true">Yes</option>
                </select>
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Max Recipients</label>
                <input class="form-control" type="number" id="interfaces_maxRecipients"
                    placeholder="Enter Max Recipients">
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">STARTTLS</label>
                <select class="form-control" id="interfaces_starttls">
                    <option value="true" selected>Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="mb-3 col-md-2">
                <label class="form-label">Secure</label>
                <select class="form-control" id="interfaces_secure">
                    <option value="false" selected>No</option>
                    <option value="true">Yes</option>
                </select>
            </div>
        </div>

        <!-- Save Buttons -->
        <div class="d-flex gap-3 mb-4">
            <button type="button" class="btn btn-success" id="saveFileBtn">Save</button>
            <button type="button" class="btn btn-primary" id="saveRestartBtn">Save & Restart</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/tomlify-j0.4/dist/tomlify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toml-j0.4/dist/toml-browser.js"></script>

<script>
    const fileNameInput = document.getElementById('fileName');
    let activeSection = 'zones'; // default section
    let serverIPs = [];
    const serverPort = 8082;

    // --- Section switching ---
    function showSection(sectionId) {
        document.querySelectorAll('.config-section').forEach(sec => sec.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';
        activeSection = sectionId;
        fileNameInput.disabled = (sectionId === 'pools');

        if (sectionId === 'pools') {
            fileNameInput.value = '';
        }
    }

    document.getElementById('btnZones').addEventListener('click', () => showSection('zones'));
    document.getElementById('btnPools').addEventListener('click', () => showSection('pools'));
    document.getElementById('btnInterfaces').addEventListener('click', () => showSection('interfaces'));

    // --- Load server IPs for Pools ---
    async function loadServerIPs(selectedIP = '') {
        try {
            const res = await fetch(`http://localhost:${serverPort}/server-ips`);
            const select = document.getElementById('pool_address');
            select && (select.innerHTML = '');
            if (!res.ok) return select && (select.innerHTML = '<option value="">Failed to load IPs</option>');

            const data = await res.json();
            serverIPs = data.ips || [];
        } catch (e) {
            console.error(e);
        }
    }

    // --- Populate form robustly ---
    function populateForm(config) {
        const topKeys = Object.keys(config);
        if (topKeys.length === 0) return;

        if (activeSection === 'zones') {
            const zoneKey = topKeys[0];
            const zone = config[zoneKey] || {};
            document.getElementById('zone_name').value = zoneKey;
            document.getElementById('zone_preferIPv6').value = zone.preferIPv6 ? 'true' : 'false';
            document.getElementById('zone_ignoreIPv6').value = zone.ignoreIPv6 ? 'true' : 'false';
            document.getElementById('zone_processes').value = Number(zone.processes) || 1;
            document.getElementById('zone_connections').value = Number(zone.connections) || 1;
            document.getElementById('zone_pool').value = zone.pool || '';
            document.getElementById('zone_senderDomains').value = (zone.senderDomains || []).join(',');
            document.getElementById('zone_recipientDomains').value = (zone.recipientDomains || []).join(',');
            document.getElementById('zone_throttling').value = zone.throttling || '';
        }
        else if (activeSection === 'interfaces') {
            const ifaceKey = topKeys[0];
            const iface = config[ifaceKey] || {};
            const hostValue = Array.isArray(iface.host) ? iface.host[0] : (iface.host || '127.0.0.1');

            document.getElementById('interfaces_enabled').value = iface.enabled ? 'true' : 'false';
            document.getElementById('interfaces_processes').value = Number(iface.processes) || 1;
            document.getElementById('interfaces_maxSize').value = Number(iface.maxSize) || 20971520;
            document.getElementById('interfaces_host').value = hostValue;
            document.getElementById('interfaces_port').value = Number(iface.port) || 2525;
            document.getElementById('interfaces_authentication').value = iface.authentication ? 'true' : 'false';
            document.getElementById('interfaces_maxRecipients').value = Number(iface.maxRecipients) || 1000;
            document.getElementById('interfaces_starttls').value = iface.starttls ? 'true' : 'false';
            document.getElementById('interfaces_secure').value = iface.secure ? 'true' : 'false';
        }
    }

    // --- Pools Section Logic ---
    const nodesContainer = document.getElementById('nodesContainer');
    const addNodeBtn = document.getElementById('addNodeBtn');

    function addNode(address = '', name = '') {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'd-flex gap-2 mb-2 node-row col-md-12';

        nodeDiv.innerHTML = `
        <select class="form-control node-address mb-4">
            <option value="">Select</option>
        </select>
        <input type="text" class="form-control node-name mb-4" placeholder="Node Name (optional)" value="${name}">
        <button type="button" class="btn btn-danger remove-node-btn mb-4">Remove</button>
    `;

        const select = nodeDiv.querySelector('.node-address');
        serverIPs.forEach(ip => {
            const opt = document.createElement('option');
            opt.value = ip;
            opt.textContent = ip;
            if (ip === address) opt.selected = true;
            select.appendChild(opt);
        });

        nodeDiv.querySelector('.remove-node-btn').addEventListener('click', () => {
            nodesContainer.removeChild(nodeDiv);
        });

        nodesContainer.appendChild(nodeDiv);
    }

    addNodeBtn.addEventListener('click', () => addNode());

    function populatePools(config) {
        const poolKey = Object.keys(config)[0];
        const poolNodes = config[poolKey] || [];
        document.getElementById('pool_name').value = poolKey;
        nodesContainer.innerHTML = '';

        if (Array.isArray(poolNodes)) {
            poolNodes.forEach(node => addNode(node.address || '', node.name || ''));
        } else if (poolNodes.nodes) {
            poolNodes.nodes.forEach(node => addNode(node.address || '', node.name || ''));
        } else {
            addNode();
        }
    }

    async function savePools() {
        const poolName = document.getElementById('pool_name').value.trim() || 'default';
        const nodeRows = Array.from(nodesContainer.querySelectorAll('.node-row'));

        const nodes = nodeRows.map(row => {
            const address = row.querySelector('.node-address').value;
            const name = row.querySelector('.node-name').value.trim();
            const obj = {};
            if (address) obj.address = address;
            if (name) obj.name = name;
            return obj;
        }).filter(node => Object.keys(node).length > 0);

        // Save as array of tables [[poolName]] format
        const config = {};
        config[poolName] = nodes;

        const content = window.tomlify.toToml(config, { space: 2 });

        const url = `/zonemta-config/pools/pools`;
        const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        if (!res.ok) throw new Error(await res.text());
        alert('Saved successfully!');
    }

    // --- Override saveFile & populateForm for Pools ---
    const originalSaveFile = saveFile;
    saveFile = function () {
        if (activeSection === 'pools') return savePools();
        return originalSaveFile();
    };

    const originalPopulateForm = populateForm;
    populateForm = function (config) {
        if (activeSection === 'pools') return populatePools(config);
        return originalPopulateForm(config);
    };

    // --- Create / Load / Save / Delete ---
    async function loadFile() {
        try {
            let name = fileNameInput.value.trim();
            if ((activeSection === 'zones' || activeSection === 'interfaces') && !name) {
                return alert('Enter a file name before loading');
            }
            if (activeSection === 'pools') name = 'pools';

            const url = `/zonemta-config/${activeSection}/${name}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(await res.text());

            const content = await res.text();
            const config = toml.parse(content);
            console.log("config", config); // debug
            populateForm(config);
            alert('Loaded successfully!');
        } catch (e) {
            alert('Error loading file: ' + e.message);
        }
    }

    async function createFile() {
        try {
            const name = fileNameInput.value.trim();
            if (!name && activeSection !== 'pools') return alert('Enter file name');

            let defaultConfig = null;
            if (activeSection === 'zones') {
                defaultConfig = { [name || 'default']: { preferIPv6: false, ignoreIPv6: true, processes: 1, connections: 1, pool: "", senderDomains: [], recipientDomains: [], throttling: "" } };
            } else if (activeSection === 'interfaces') {
                defaultConfig = { [name || 'default']: { enabled: true, processes: 1, maxSize: 20971520, host: '127.0.0.1', port: 2525, authentication: false, maxRecipients: 1000, starttls: true, secure: false } };
            } else if (activeSection === 'pools') {
                defaultConfig = { [name || 'default']: { nodes: [{ address: "", name: "" }] } };
            }

            const content = window.tomlify.toToml(defaultConfig, { space: 2 });
            const url = activeSection === 'pools' ? `/zonemta-config/pools/pools` : `/zonemta-config/${activeSection}/${name}`;

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            if (!res.ok) throw new Error(await res.text());
            populateForm(defaultConfig);
            alert('File created successfully!');
        } catch (e) {
            alert('Error creating file: ' + e.message);
        }
    }

    async function saveFile() {
        try {
            const name = fileNameInput.value.trim();
            if (!name && activeSection !== 'pools') return alert('Enter file name');

            let config = null;

            if (activeSection === 'zones') {
                const zoneName = document.getElementById('zone_name').value.trim();
                config = {
                    [zoneName]: {
                        preferIPv6: document.getElementById('zone_preferIPv6').value === 'true',
                        ignoreIPv6: document.getElementById('zone_ignoreIPv6').value === 'true',
                        processes: Number(document.getElementById('zone_processes').value),
                        connections: Number(document.getElementById('zone_connections').value),
                        pool: document.getElementById('zone_pool').value,
                        senderDomains: document.getElementById('zone_senderDomains').value.split(',').map(s => s.trim()),
                        recipientDomains: document.getElementById('zone_recipientDomains').value.split(',').map(s => s.trim()),
                        throttling: document.getElementById('zone_throttling').value
                    }
                };
            } else if (activeSection === 'interfaces') {
                const ifaceName = name || 'default';
                config = {
                    [ifaceName]: {
                        enabled: document.getElementById('interfaces_enabled').value === 'true',
                        processes: Number(document.getElementById('interfaces_processes').value),
                        maxSize: Number(document.getElementById('interfaces_maxSize').value),
                        host: document.getElementById('interfaces_host').value,
                        port: Number(document.getElementById('interfaces_port').value),
                        authentication: document.getElementById('interfaces_authentication').value === 'true',
                        maxRecipients: Number(document.getElementById('interfaces_maxRecipients').value),
                        starttls: document.getElementById('interfaces_starttls').value === 'true',
                        secure: document.getElementById('interfaces_secure').value === 'true'
                    }
                };
            } else if (activeSection === 'pools') {
                const poolName = document.getElementById('pool_name').value.trim() || 'default';
                config = {
                    [poolName]: {
                        nodes: [{
                            address: document.getElementById('pool_address').value,
                            name: document.getElementById('pool_nodeName').value
                        }]
                    }
                };
            }

            const content = window.tomlify.toToml(config, { space: 2 });
            const url = activeSection === 'pools' ? `/zonemta-config/pools/pools` : `/zonemta-config/${activeSection}/${name}`;

            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            if (!res.ok) throw new Error(await res.text());
            alert('Saved successfully!');
        } catch (e) {
            alert('Error saving file: ' + e.message);
        }
    }

    async function deleteFile() {
        try {
            const name = fileNameInput.value.trim();
            if (!name) return alert('Enter file name');
            if (!confirm(`Delete ${name}?`)) return;
            const res = await fetch(`/zonemta-config/${activeSection}/${name}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text());
            alert('Deleted successfully!');
        } catch (e) {
            alert('Error deleting file: ' + e.message);
        }
    }

    async function saveAndRestart() {
        await saveFile();
        const res = await fetch('/zonemta-restart', { method: 'POST' });
        if (!res.ok) throw new Error(await res.text());
        alert('ZoneMTA restarted!');
    }

    // --- Button events ---
    document.getElementById('loadFileBtn').addEventListener('click', loadFile);
    document.getElementById('createFileBtn').addEventListener('click', createFile);
    document.getElementById('saveFileBtn').addEventListener('click', saveFile);
    document.getElementById('saveRestartBtn').addEventListener('click', saveAndRestart);
    document.getElementById('deleteFileBtn').addEventListener('click', deleteFile);

    // Load server IPs on start
    window.addEventListener('DOMContentLoaded', () => loadServerIPs());
</script>

<style>
    .form-label {
        font-weight: 500;
        margin-top: 0.5rem;
    }

    .mb-3 {
        margin-bottom: 1rem;
    }

    .mb-4 {
        margin-bottom: 1.5rem;
    }

    .mt-2 {
        margin-top: 0.5rem;
    }
</style>